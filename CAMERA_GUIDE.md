# 摄像头实时检测使用指南

## 功能概述

系统现已支持摄像头实时检测，可以：
- ✅ 实时检测红领巾佩戴情况
- ✅ 检测敬礼姿态是否标准
- ✅ 当检测到正确佩戴红领巾且敬礼时，提示并鼓励用户
- ✅ 实时显示检测统计信息
- ✅ 支持多个摄像头输入

## 系统要求

- Python 3.8+
- conda虚拟环境（使用red环境）
- 支持的摄像头设备
- 足够的光线照明

## 快速启动

### 方式一：启动Web界面（推荐）

```bash
# 1. 进入项目目录
cd /Users/ronggang/code/funcode/redscarf

# 2. 激活虚拟环境
conda activate red

# 3. 启动应用
python run_app.py
```

然后在浏览器中：
1. 打开显示的URL（通常是 `http://localhost:7860`）
2. 点击"🎥 摄像头实时检测"标签页
3. 设置摄像头ID（通常为0）
4. 点击"▶️ 启动摄像头"开始检测
5. 点击"⏹️ 停止摄像头"结束检测

### 方式二：命令行测试

```bash
# 进入RedScarf目录
cd /Users/ronggang/code/funcode/redscarf/RedScarf

# 运行测试脚本（采样10帧进行测试）
python test_camera.py --camera 0 --frames 10

# 或者测试更多帧
python test_camera.py --camera 0 --frames 50
```

## 界面说明

### 摄像头实时检测标签页

#### 左侧显示
- **摄像头画面**：实时视频流，标注了检测结果
- **检测信息**：实时统计和鼓励提示

#### 右侧控制
- **▶️ 启动摄像头**：开始实时检测
- **⏹️ 停止摄像头**：停止实时检测
- **摄像头ID**：选择使用的摄像头（0为默认）
- **状态**：显示当前运行状态

## 检测结果说明

### 颜色标记
- 🟢 **绿色框**：已正确佩戴红领巾
- 🔴 **红色框**：未佩戴红领巾
- 🟣 **紫色框**：标准敬礼姿态（得分≥85分）
- 🟡 **黄色骨架**：人体关键点和姿态信息

### 实时统计
- **检测到的人数**：当前画面中检测到的人数
- **已佩戴红领巾**：佩戴红领巾的人数
- **未佩戴红领巾**：未佩戴红领巾的人数
- **正在敬礼**：做出敬礼动作的人数
- **检测速度**：处理速度（FPS）
- **佩戴率**：佩戴红领巾的百分比

### 鼓励信息 🎉

当系统检测到用户：
1. ✅ 正确佩戴红领巾
2. ✅ 做出敬礼动作

系统会自动显示随机的鼓励信息，包括：
- "🌟 太棒了！正确佩戴红领巾！"
- "🎉 优秀！标准敬礼姿态！"
- "👍 敬礼姿态标准，继续加油！"
- 等等...

每个鼓励信息会持续显示3秒，然后切换为新的信息（如果仍然满足条件）。

## 高级用法

### 选择特定摄像头

如果你的电脑连接了多个摄像头：
- ID 0：通常是内置或默认摄像头
- ID 1, 2, ...：外接摄像头

在Web界面中拖动"摄像头ID"滑块选择。

### 调整检测参数

修改 `config.py` 中的参数：

```python
# 人体检测置信度（0-1，越高越严格）
PERSON_CONF_THRESHOLD = 0.5

# 红领巾检测置信度（推荐0.55）
REDSCARF_CONF_THRESHOLD = 0.55

# 敬礼角度范围（单位：度）
SALUTE_ANGLE_MIN = 60
SALUTE_ANGLE_MAX = 120
```

## 常见问题

### Q: 摄像头无法打开？
A: 
1. 确保摄像头已连接并被系统识别
2. 检查是否有其他应用占用摄像头
3. 尝试更改摄像头ID（如改为1或2）
4. 在macOS上，确保已授予应用摄像头权限

### Q: 检测不准确？
A:
1. 确保光线充足
2. 摄像头镜头清洁
3. 人物完整可见在摄像头范围内
4. 距摄像头距离在1-3米为最佳

### Q: 鼓励信息没有出现？
A:
1. 确保用户佩戴了红领巾
2. 确保做出了敬礼动作（手肘角度60-120度）
3. 敬礼姿态得分需要≥60分
4. 鼓励信息每3秒更新一次，可能需要等待

### Q: 运行速度慢？
A:
1. 降低视频分辨率
2. 关闭其他应用释放CPU
3. 如果有GPU，可改用GPU模式
4. 减少检测帧率（适度延迟时间）

## 技术细节

### 摄像头处理流程

1. **启动线程**：后台独立线程处理摄像头输入
2. **实时检测**：每帧执行目标检测和姿态识别
3. **异步更新**：Web界面定时刷新显示最新结果
4. **非阻塞**：检测过程不阻塞用户界面操作

### 性能优化

- 使用后台线程避免UI卡顿
- 帧率限制防止CPU过载
- 异步更新机制提高响应速度
- 内存管理防止长期运行内存泄漏

## 扩展功能

你可以进一步定制：

1. **修改鼓励信息**：编辑 `app.py` 中的 `praise_list`
2. **调整检测频率**：修改 `timer.change()` 中的 `every` 参数
3. **保存视频记录**：扩展 `_camera_thread()` 添加视频写入
4. **多人检测统计**：自定义统计逻辑和报告

## 反馈和问题

如有问题或建议，请修改以下文件进行调试：

- `app.py`：Web界面逻辑
- `detection_service.py`：检测服务核心
- `config.py`：参数配置

---

**版本**：v4.0 (摄像头实时检测 + 智能鼓励)  
**最后更新**：2024年11月
